{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block head %}
<script>
    // Pass server-side monitoring state to JS
    const MONITORING_ACTIVE = {{ monitoring_active | tojson }};
</script>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div class="page-title">üìä Dashboard</div>
        <div class="page-subtitle">Live classroom monitoring overview</div>
    </div>
    <div class="flex gap-2">
        <button class="btn btn-danger btn-sm" onclick="clearAllData()">üóë Clear Data</button>
        <a href="{{ url_for('add_student') }}" class="btn btn-primary btn-sm">+ Add Student</a>
    </div>
</div>

<!-- ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">üéì</div>
        <div>
            <div class="stat-value" id="stat-students">{{ total_students }}</div>
            <div class="stat-label">Registered Students</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green">üìã</div>
        <div>
            <div class="stat-value" id="stat-entries">{{ today_entries }}</div>
            <div class="stat-label">Today's Entries</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon red">üö®</div>
        <div>
            <div class="stat-value" id="stat-alerts">{{ active_alerts | length }}</div>
            <div class="stat-label">Active Alerts</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple">üìπ</div>
        <div>
            <div class="stat-value" id="stat-monitoring">
                {% if monitoring_active %}üü¢ Active{% else %}üî¥ Inactive{% endif %}
            </div>
            <div class="stat-label">Camera Status</div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ -->
<div class="dashboard-grid">

    <!-- LEFT: Camera + Recent Entries -->
    <div style="display:flex;flex-direction:column;gap:20px;">

        <!-- CAMERA PANEL -->
        <div class="camera-panel">
            <div class="camera-header">
                <div class="card-title">Live Camera Feed</div>
                <div class="camera-status">
                    <div class="status-dot {% if monitoring_active %}active{% endif %}" id="camera-status-dot"></div>
                    <span id="camera-status-text">{% if monitoring_active %}Live{% else %}Inactive{% endif %}</span>
                </div>
            </div>

            <div class="camera-viewport">
                <!-- Browser getUserMedia stream ‚Äî no server round-trip needed -->
                <video id="camera-video" autoplay playsinline muted
                    style="display:none;width:100%;height:100%;object-fit:cover;"></video>
                <!-- Placeholder shown when camera is off -->
                <div id="camera-placeholder" class="camera-placeholder"
                    style="{% if monitoring_active %}display:none{% else %}display:flex{% endif %}">
                    <div class="ph-icon">üì∑</div>
                    <div>Camera is not active</div>
                    <small class="text-muted">Click Start Monitoring below</small>
                </div>
            </div>

            <div class="camera-controls">
                <button id="btn-start" class="btn btn-success" onclick="CameraFeed.startMonitoring()" {% if
                    monitoring_active %}disabled{% endif %}>
                    ‚ñ∂ Start Monitoring
                </button>
                <button id="btn-stop" class="btn btn-danger" onclick="CameraFeed.stopMonitoring()" {% if not
                    monitoring_active %}disabled{% endif %}>
                    ‚èπ Stop
                </button>
                <button class="btn btn-outline btn-sm" onclick="stopAlarm()" style="margin-left:auto;">
                    üîï Stop Alarm
                </button>
            </div>
        </div>

        <!-- RECENT ENTRIES TABLE -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">üìã Recent Entries</div>
                <a href="{{ url_for('entry_logs') }}" class="btn btn-outline btn-sm">View All</a>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Student</th>
                            <th>Status</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="recent-entries-body">
                        {% if recent_entries %}
                        {% for entry in recent_entries %}
                        <tr>
                            <td>{{ entry.entry_time.strftime('%d %b %H:%M') }}</td>
                            <td>{{ entry.student.name if entry.student else 'Unknown' }}</td>
                            <td>
                                {% if entry.is_recognized %}
                                <span class="badge badge-green">‚úÖ Recognised</span>
                                {% else %}
                                <span class="badge badge-red">‚ùå Unknown</span>
                                {% endif %}
                            </td>
                            <td>{{ '%.0f%%' % (entry.confidence_score * 100) if entry.confidence_score else '‚Äî' }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr class="empty-row">
                            <td colspan="4">No entries recorded yet</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

    </div><!-- /LEFT -->

    <!-- RIGHT: Alerts + Info -->
    <div class="side-panel">

        <!-- ACTIVE ALERTS -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    üö® Active Alerts
                    {% if active_alerts %}
                    <span class="badge badge-red badge-pulse">{{ active_alerts | length }}</span>
                    {% endif %}
                </div>
                <a href="{{ url_for('alerts') }}" class="btn btn-outline btn-sm">All Alerts</a>
            </div>
            <div class="card-body" id="active-alerts-list">
                {% if active_alerts %}
                {% for alert in active_alerts %}
                <div class="alert-item">
                    <div class="alert-icon {{ alert.severity }}">
                        {% if alert.severity == 'high' %}üö®
                        {% elif alert.severity == 'medium' %}‚ö†Ô∏è
                        {% else %}‚ÑπÔ∏è{% endif %}
                    </div>
                    <div class="alert-body">
                        <div class="alert-msg">{{ alert.message }}</div>
                        <div class="alert-meta">
                            {{ alert.created_at.strftime('%d %b %H:%M') }} ¬∑
                            <span
                                class="badge badge-{% if alert.severity == 'high' %}red{% elif alert.severity == 'medium' %}yellow{% else %}blue{% endif %}">
                                {{ alert.severity }}
                            </span>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success" onclick="resolveAlert({{ alert.id }})">‚úî
                                Resolve</button>
                            <button class="btn btn-sm btn-danger" style="margin-left:6px" onclick="stopAlarm()">üîï
                                Alarm</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted text-center mt-3" style="padding-bottom:8px;">No active alerts üéâ</p>
                {% endif %}
            </div>
        </div>

        <!-- SYSTEM INFO -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">‚ÑπÔ∏è System Info</div>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">AI Model</span>
                    <span class="info-value" style="font-size:12px;">gemini-flash-1.5</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Detection Cooldown</span>
                    <span class="info-value">10 s</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Match Threshold</span>
                    <span class="info-value">75%</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Frame Rate</span>
                    <span class="info-value">15 fps</span>
                </div>
            </div>
        </div>

    </div><!-- /RIGHT -->
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>
{% endblock %}